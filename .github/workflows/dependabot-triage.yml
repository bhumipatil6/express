# .github/workflows/dependabot-triage-safe.yml
# SAFE VERSION: Creates issues with fix instructions, NOT PRs
# No contents:write permission needed - follows GoDaddy security standards

name: Dependabot Triage (Safe)

on:
  workflow_dispatch:
    inputs:
      max_alerts:
        description: 'Maximum alerts to process'
        required: false
        default: '50'
      create_issues:
        description: 'Create GitHub issues for top alerts'
        required: false
        default: 'true'
        type: boolean
      top_n:
        description: 'Number of top alerts to create issues for'
        required: false
        default: '5'
  
  schedule:
    - cron: '0 9 * * 1'

jobs:
  triage:
    name: Analyze and Prioritize
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: read        # Read-only for code
      security-events: read # Read Dependabot alerts
      issues: write         # Create issues (safe - no code changes)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Dependabot Alerts
        id: fetch-alerts
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/dependabot/alerts?state=open&per_page=${{ inputs.max_alerts || 50 }}" \
            > /tmp/raw_alerts.json
          
          count=$(jq 'length' /tmp/raw_alerts.json)
          echo "count=$count" >> $GITHUB_OUTPUT

      - name: Fetch EPSS Scores
        run: |
          cves=$(jq -r '.[].security_advisory.cve_id // empty' /tmp/raw_alerts.json \
            | sort -u | head -50 | tr '\n' ',' | sed 's/,$//')
          
          if [ -n "$cves" ]; then
            curl -s "https://api.first.org/data/v1/epss?cve=${cves}" > /tmp/epss_raw.json
            jq '[.data[]? | {(.cve): (.epss | tonumber)}] | add // {}' /tmp/epss_raw.json > /tmp/epss_scores.json
          else
            echo '{}' > /tmp/epss_scores.json
          fi

      - name: Calculate ROI and Generate Fix Commands
        id: analyze
        run: |
          cat << 'PYTHON_SCRIPT' > /tmp/analyze.py
          import json
          import re
          
          def load_json(path, default):
              try:
                  with open(path) as f:
                      return json.load(f)
              except:
                  return default
          
          alerts = load_json('/tmp/raw_alerts.json', [])
          epss_scores = load_json('/tmp/epss_scores.json', {})
          
          def get_update_type(current, patched):
              if not current or not patched:
                  return 'unknown'
              def parse(v):
                  m = re.match(r'^(\d+)\.(\d+)\.(\d+)', str(v))
                  return tuple(map(int, m.groups())) if m else (0,0,0)
              c, p = parse(current), parse(patched)
              if c[0] != p[0]: return 'major'
              elif c[1] != p[1]: return 'minor'
              elif c[2] != p[2]: return 'patch'
              return 'unknown'
          
          def calculate_roi(alert):
              advisory = alert.get('security_advisory', {})
              vuln = alert.get('security_vulnerability', {})
              
              cve_id = advisory.get('cve_id', 'N/A')
              severity = advisory.get('severity', 'medium')
              cvss = advisory.get('cvss', {}).get('score', 5.0)
              epss = epss_scores.get(cve_id, 0.1)
              
              package = vuln.get('package', {}).get('name', 'unknown')
              first_patched = vuln.get('first_patched_version', {}).get('identifier', '')
              
              current_match = re.search(r'(\d+\.\d+\.\d+)', vuln.get('vulnerable_version_range', ''))
              current = current_match.group(1) if current_match else ''
              
              update_type = get_update_type(current, first_patched)
              
              scope = alert.get('dependency', {}).get('scope', 'runtime')
              scope_mult = 3.0 if scope == 'runtime' else 1.5
              
              effort_map = {'patch': 1, 'minor': 1.5, 'major': 3, 'unknown': 2}
              effort = effort_map.get(update_type, 2)
              
              roi = (cvss * epss * 100 * scope_mult) / effort
              
              # Generate fix command
              if first_patched:
                  fix_cmd = f"npm install {package}@{first_patched} --save"
              else:
                  fix_cmd = f"npm install {package}@latest --save"
              
              return {
                  'alert_number': alert.get('number'),
                  'package': package,
                  'severity': severity,
                  'cve_id': cve_id,
                  'cvss': round(cvss, 1),
                  'epss': round(epss, 4),
                  'roi': round(roi, 2),
                  'current_version': current,
                  'patched_version': first_patched,
                  'update_type': update_type,
                  'safe_update': update_type in ['patch', 'minor'],
                  'fix_command': fix_cmd,
                  'summary': advisory.get('summary', '')[:150],
                  'html_url': alert.get('html_url', '')
              }
          
          results = []
          for alert in alerts:
              try:
                  results.append(calculate_roi(alert))
              except Exception as e:
                  print(f"Warning: {e}")
          
          results.sort(key=lambda x: x['roi'], reverse=True)
          
          with open('/tmp/prioritized_alerts.json', 'w') as f:
              json.dump(results, f, indent=2)
          
          # Group by package for batch fix commands
          packages = {}
          for r in results:
              pkg = r['package']
              if pkg not in packages or r['roi'] > packages[pkg]['roi']:
                  packages[pkg] = r
          
          with open('/tmp/package_fixes.json', 'w') as f:
              json.dump(list(packages.values()), f, indent=2)
          
          print(f"Processed {len(results)} alerts")
          print(f"Unique packages: {len(packages)}")
          PYTHON_SCRIPT
          
          python3 /tmp/analyze.py

      - name: Create Issues for Top Alerts
        if: inputs.create_issues == 'true' || inputs.create_issues == ''
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TOP_N=${{ inputs.top_n || 5 }}
          
          # Read top alerts
          jq -c ".[:${TOP_N}][]" /tmp/prioritized_alerts.json | while read -r alert; do
            PACKAGE=$(echo "$alert" | jq -r '.package')
            VERSION=$(echo "$alert" | jq -r '.patched_version')
            SEVERITY=$(echo "$alert" | jq -r '.severity')
            CVE=$(echo "$alert" | jq -r '.cve_id')
            ROI=$(echo "$alert" | jq -r '.roi')
            FIX_CMD=$(echo "$alert" | jq -r '.fix_command')
            SUMMARY=$(echo "$alert" | jq -r '.summary')
            ALERT_URL=$(echo "$alert" | jq -r '.html_url')
            UPDATE_TYPE=$(echo "$alert" | jq -r '.update_type')
            SAFE=$(echo "$alert" | jq -r '.safe_update')
            
            # Check if issue already exists
            EXISTING=$(gh issue list --search "Security: Update $PACKAGE" --json number --jq 'length')
            if [ "$EXISTING" -gt 0 ]; then
              echo "â­ï¸ Issue for $PACKAGE already exists, skipping"
              continue
            fi
            
            # Set labels based on severity and safety
            if [ "$SAFE" = "true" ]; then
              LABELS="security,dependabot,safe-update,$SEVERITY"
            else
              LABELS="security,dependabot,breaking-change,$SEVERITY"
            fi
            
            # Create issue
            gh issue create \
              --title "ðŸ”’ Security: Update $PACKAGE to $VERSION" \
              --label "$LABELS" \
              --body "## Security Update Required

          **Package:** \`$PACKAGE\`
          **Current â†’ Patched:** \`$VERSION\`
          **Update Type:** $UPDATE_TYPE
          **Safe to Update:** $( [ \"$SAFE\" = \"true\" ] && echo \"âœ… Yes\" || echo \"âš ï¸ Review Required\" )

          ### Security Details

          | Metric | Value |
          |--------|-------|
          | **CVE** | $CVE |
          | **Severity** | $SEVERITY |
          | **ROI Score** | $ROI |

          ### Summary
          $SUMMARY

          ### ðŸ› ï¸ Fix Command

          \`\`\`bash
          # Run this in your local repo:
          $FIX_CMD

          # Then verify and commit:
          npm test
          git add package.json package-lock.json
          git commit -m \"fix(security): update $PACKAGE to $VERSION\"
          git push
          \`\`\`

          ### Links
          - [Dependabot Alert]($ALERT_URL)

          ---
          *Auto-generated by Dependabot Triage workflow*
          *ROI = (CVSS Ã— EPSS Ã— 100 Ã— Scope) / Effort*"
            
            echo "âœ… Created issue for $PACKAGE"
            
            # Rate limit protection
            sleep 1
          done

      - name: Generate Summary Report
        if: always()
        run: |
          echo "## ðŸ”’ Dependabot Triage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Alerts Analyzed:** ${{ steps.fetch-alerts.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Top 10 Priority Alerts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Severity | CVE | ROI | Update | Safe? | Fix Command |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|:--------:|-----|----:|--------|:-----:|-------------|" >> $GITHUB_STEP_SUMMARY
          
          jq -r '.[:10][] | "| \(.package) | \(.severity) | \(.cve_id) | \(.roi) | \(.update_type) | \(if .safe_update then "âœ…" else "âš ï¸" end) | `\(.fix_command)` |"' \
            /tmp/prioritized_alerts.json >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Batch Fix Commands (Copy & Paste)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run these locally to fix multiple vulnerabilities:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Safe updates (patch/minor only):" >> $GITHUB_STEP_SUMMARY
          jq -r '.[:10][] | select(.safe_update) | .fix_command' /tmp/prioritized_alerts.json >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Then test and commit:" >> $GITHUB_STEP_SUMMARY
          echo "npm test" >> $GITHUB_STEP_SUMMARY
          echo "git add package.json package-lock.json" >> $GITHUB_STEP_SUMMARY
          echo 'git commit -m "fix(security): update vulnerable dependencies"' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ROI = (CVSS Ã— EPSS Ã— 100 Ã— Scope) / Effort*" >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: triage-results-${{ github.run_number }}
          path: /tmp/prioritized_alerts.json
